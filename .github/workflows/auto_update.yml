name: Auto Update

# The 'kubebuilder alpha update' command requires write access to the repository to create a branch
# with the update files and allow you to open a pull request using the link provided in the issue.
# The branch created will be named in the format kubebuilder-update-from-<from-version>-to-<to-version> by default.
# To protect your codebase, please ensure that you have branch protection rules configured for your
# main branches. This will guarantee that no one can bypass a review and push directly to a branch like 'main'.
permissions:
  contents: write # Create and push the update branch
  issues: write # Create GitHub Issue with PR link

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 2" # Every Tuesday at 00:00 UTC

jobs:
  auto-update:
    runs-on: ubuntu-latest

    # Checkout the repository.
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Configure Git to create commits with the GitHub Actions bot.
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Set up Go environment.
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      # Install Kubebuilder.
      - name: Install Kubebuilder
        run: |
          curl -L -o kubebuilder "https://go.kubebuilder.io/dl/latest/$(go env GOOS)/$(go env GOARCH)"
          chmod +x kubebuilder
          sudo mv kubebuilder /usr/local/bin/
          kubebuilder version

      # Run the Kubebuilder alpha update command.
      # More info: https://kubebuilder.io/reference/commands/alpha_update
      - name: Run kubebuilder alpha update
        # Executes the update command with specified flags.
        # --force: Completes the merge even if conflicts occur, leaving conflict markers.
        # --push: Automatically pushes the resulting output branch to the 'origin' remote.
        # --restore-path: Preserves specified paths (e.g., CI workflow files) when squashing.
        # --open-gh-issue: Creates a GitHub Issue with a link for opening a PR for review.
        #
        # WARNING: This workflow does not use GitHub Models AI summary by default.
        # To enable AI-generated summaries in GitHub issues, you need permissions to use GitHub Models.
        # If you have the required permissions, re-run:
        #   kubebuilder edit --plugins="autoupdate/v1-alpha" --use-gh-models
        run: |
          kubebuilder alpha update \
            --force \
            --push \
            --restore-path .github/workflows \
            --open-gh-issue
